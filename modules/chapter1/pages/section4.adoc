= Lab: Adding Custom Models to the OpenShift AI Model Catalog
:toc: macro
:source-highlighter: rouge

This lab guides you through manually registering external models (e.g., from Hugging Face) into the OpenShift AI Model Catalog using the file-based configuration method.

== Prerequisites

* Access to the OpenShift Cluster via a terminal (`oc` CLI).
* `cluster-admin` privileges (or permissions to edit ConfigMaps in the model registry namespace).

== Procedure

=== 1. Switch to the Registry Namespace

First, ensure you are working in the correct namespace where the Model Registry components are running.

[source,bash]
----
oc project rhoai-model-registries
----

=== 2. Open the Catalog Configuration

The Model Catalog does not use a database for configuration; it uses a Kubernetes **ConfigMap**. You will edit this object directly.

[source,bash]
----
oc edit configmap model-catalog-sources
----

[NOTE]
====
You are editing a **ConfigMap**, not a local file. The file `sources.yaml` exists virtually inside the `data` section of this object.
====

=== 3. configure the Registry and Add Models

You need to define two logical "files" inside this ConfigMap:

 1.  **`sources.yaml`**: Registers your custom catalog path.
 2.  **`my-models.yaml`**: Contains the actual metadata for your models.

Copy and paste the following block into the `data:` section of the ConfigMap.

.Understanding the Schema
* **Top-Level Fields:** Only `name`, `description`, `readme`, and `maturity` are allowed here.
* **customProperties:** You **must** put `author`, `version`, `model_type`, and other metadata here to avoid errors.

[source,yaml]
----
apiVersion: v1
kind: ConfigMap
metadata:
  name: model-catalog-sources
  namespace: rhoai-model-registries
data:
  # FILE 1: The Main Config - Points to your custom file
  sources.yaml: |
    catalogs:
      - name: "Model-Registry-Lab"
        id: "registry-custom-models"
        type: "yaml"
        properties:
          yamlCatalogPath: "/data/user-sources/registry-models.yaml"

  # FILE 2: Your Model Definitions (Add models here)
  registry-models.yaml: |
    models:
      # --- MODEL 1: IBM Granite ---
      - name: "granite-3.0-2b-instruct"
        description: "IBM Granite Small Language Model"
        customProperties:
          model_type:
            metadataType: MetadataStringValue
            string_value: "generative"
          author:
            metadataType: MetadataStringValue
            string_value: "IBM"
          version:
            metadataType: MetadataStringValue
            string_value: "1.0"
        artifacts:
          - name: "model-artifact"
            uri: "oci://quay.io/redhat-ai-services/modelcar-catalog:granite-3.0-2b-instruct"

----

=== 4. Save and Exit

* **Vi/Vim Users:** Press `Esc`, then type `:wq` and hit `Enter`.
* **Nano Users:** Press `Ctrl+O`, `Enter`, then `Ctrl+X`.

If the edit is successful, you will see:
`configmap/model-catalog-sources edited`

=== 5. Apply Changes (Force Reload)

The catalog service attempts to "hot reload" changes, but it is best practice in a lab environment to restart the pod to ensure a clean state and immediate update.

[source,bash]
----
oc delete pod -l component=model-catalog -n rhoai-model-registries
----

Wait for the new pod to start (Status: `Running`):

[source,bash]
----
oc get pods -l component=model-catalog -w
----

== Verification

Before checking the Dashboard, verify the API is serving your new models.

[source,bash]
----
# 1. Open a port-forward tunnel (run this in the background or a separate tab)
oc port-forward svc/model-catalog 8080:8080 &

# 2. Query your specific source ID
curl -s "http://localhost:8080/api/model_catalog/v1alpha1/models?source=lab-custom-models"
----

**Expected Output:**
You should see a JSON response containing both `"name": "phi-2"` and `"name": "granite-7b-lab"`.

== Visual Verification

1.  Open your **Red Hat OpenShift AI Dashboard** in your browser.
2.  Navigate to the **Model Catalog** tab in the left sidebar.
3.  Look for a new section or tab (depending on UI version) labeled **"Private Enterprise Registry"**.
4.  **Success:** You should see the card for **"Granite 7B Enterprise"**.
5.  Click the card. Notice that the deployment source is **NOT** Hugging Face. It is your private S3 bucket URI.

image::private-catalog-card.png[align="center", title="Your Private Model, Ready for Deployment"]

== Troubleshooting

* **Error:** `json: unknown field "author"`
    * **Fix:** You placed `author` at the top level of the YAML. Move it inside `customProperties`.
* **Error:** `sources.yaml: no such file or directory`
    * **Fix:** You likely accidentally deleted the `sources.yaml` key in the ConfigMap. Re-copy the full YAML block from Step 3.
* **Dashboard Issue:** Models not visible in the UI.
    * **Fix:** In the OpenShift AI Model Catalog, check the **Source** filter. Uncheck "Red Hat AI" and ensure "Training Lab Models" (or "All sources") is selected.

